/**handles:wpcom-notes-common**/
var wpNotesCommon,wpNotesCommentModView,wpNoteList,wpNoteModel;!function(t){var e=document.cookie.split(/;\s*/),n=!1;for(i=0;i<e.length;i++)if(e[i].match(/^wp_api=/)){e=e[i].split("="),n=e[1];break}wpNotesCommon={jsonAPIbase:"https://public-api.wordpress.com/rest/v1",hasUpgradedProxy:!1,noteTypes:{comment:"comment",follow:"follow",like:["like","like_trap"],reblog:"reblog",trophy:["best_liked_day_feat","like_milestone_achievement","achieve_automattician_note","achieve_user_anniversary","best_followed_day_feat","followed_milestone_achievement"],alert:["expired_domain_alert"]},noteType2Noticon:{like:"like",follow:"follow",comment_like:"like",comment:"comment",comment_pingback:"external",reblog:"reblog",like_milestone_achievement:"trophy",achieve_followed_milestone_note:"trophy",achieve_user_anniversary:"trophy",best_liked_day_feat:"milestone",best_followed_day_feat:"milestone",automattician_achievement:"trophy",expired_domain_alert:"alert",automattcher:"atsign"},createNoteContainer:function(e,n){var o=t("<div/>",{id:n+"-note-"+e.id,class:"wpn-note wpn-"+e.type+" "+(e.unread>0?"wpn-unread":"wpn-read")}).data({id:parseInt(e.id,10),type:e.type}),a=t("<div/>",{class:"wpn-note-body wpn-note-body-empty"}),s=t("<div/>",{style:"position: absolute; left: 180px; top: 60px;"});return a.append(s),s.spin("medium"),o.append(this.createNoteSubject(e),a),o},createNoteSubject:function(e){var n=t("<div/>",{class:"wpn-note-summary"}).append(t("<span/>",{class:"wpn-noticon noticon noticon"+e.noticon}),t("<span/>",{class:"wpn-icon no-grav",html:t("<img/>",{src:e.subject.icon,width:"24px",height:"24px",style:"display: inline-block; width: 24px; height: 24px; overflow-x: hidden; overflow-y: hidden;"})}),t("<span/>",{class:"wpn-subject",html:e.subject.html}));return n},createNoteBody:function(e){var n=t("<div/>",{class:"wpn-note-body"}),o=e.toJSON(),a="wpn-"+o.body.template;switch(o.body.template){case"single-line-list":case"multi-line-list":n.append(t("<p/>").addClass(a+"-header").html(o.body.header));for(var s in o.body.items){var i=t("<div></div>",{class:a+"-item "+a+"-item-"+s+(o.body.items[s].icon?"":" "+a+"-item-no-icon")});if(o.body.items[s].icon&&i.append(t("<img/>",{class:a+"-item-icon avatar avatar-"+o.body.items[s].icon_width,height:o.body.items[s].icon_height,width:o.body.items[s].icon_width,src:o.body.items[s].icon})),o.body.items[s].header&&i.append(t("<div></div>",{class:a+"-item-header"}).html(o.body.items[s].header)),o.body.items[s].action)switch(o.body.items[s].action.type){case"follow":var r=wpFollowButton.create(o.body.items[s].action);i.append(r),r.click(function(e){return t(this).children("a").hasClass("wpcom-follow-rest")?wpNotesCommon.bumpStat("notes-click-action","unfollow"):wpNotesCommon.bumpStat("notes-click-action","follow"),!0});break;default:console.error("Unsupported "+o.type+" action: "+o.body.items[s].action.type)}o.body.items[s].html&&i.append(t("<div></div>",{class:a+"-item-body"}).html(o.body.items[s].html)),n.append(i)}if(o.body.actions){var m=new wpNotesCommentModView({model:e});m.render(),n.append(m.el)}o.body.footer&&n.append(t("<p/>").addClass(a+"-footer").html(o.body.footer));break;case"big-badge":o.body.header&&n.append(t("<div/>").addClass(a+"-header").html(o.body.header)),o.body.badge&&n.append(t("<div></div>",{class:a+"-badge "}).append(o.body.badge)),""!==o.body.html&&n.append(t("<div/>").addClass(a+"-footer").html(o.body.html));break;default:n.text("Unsupported note body template!")}return n.find("a[notes-data-click]").mousedown(function(e){var n=t(this).attr("notes-data-click");return wpNotesCommon.bumpStat("notes-click-body",n),!0}),n},getNoteSubjects:function(t,e,n){return t.fields="id,type,unread,noticon,timestamp,subject",t.trap=!0,this.getNotes(t,e,n)},getNotes:function(t,e,n){return this.ajax({type:"GET",path:"/notifications/",data:t,success:e,error:n})},getMentions:function(t,e){return this.ajax({type:"GET",path:"/users/suggest",data:t,success:e})},markNotesSeen:function(t){return this.ajax({type:"POST",path:"/notifications/seen",data:{time:t}})},markNotesRead:function(e){var n={},o=this;for(var a in e)e[a]>0&&(n["counts["+a+"]"]=e[a]);return 0===n.length?(new t.Deferred).resolve("no unread notes"):this.ajax({type:"POST",path:"/notifications/read",data:n,success:function(t){},error:function(t){}})},ajax:function(e){var n=this,o={path:e.path,method:e.type};return"post"==e.type.toLowerCase()?o.body=e.data:o.query=e.data,t.Deferred(function(a){var s=function(){t.wpcom_proxy_request(o,function(t,n){return 200==n?("function"==typeof e.success&&e.success(t),a.resolve(t)):("function"==typeof e.error?e.error(n):console.error(n),a.reject(n))})};return n.hasUpgradedProxy?s():t.wpcom_proxy_request({metaAPI:{accessAllUsersBlogs:!0}}).done(function(){n.hasUpgradedProxy=!0,s()})})},bumpStat:function(t,e){if("undefined"!=typeof wpNotesIsJetpackClient&&wpNotesIsJetpackClient){var n=["notes-menu-impressions","notes-menu-clicks"];_.contains(n,t)&&(e=e.replace(/(,|$)/g,"-jetpack$1"))}(new Image).src=document.location.protocol+"//pixel.wp.com/g.gif?v=wpcom-no-pv&x_"+t+"="+e+"&baba="+Math.random()},getKeycode:function(t){if(t=t||window.event,t.target?element=t.target:t.srcElement&&(element=t.srcElement),3==element.nodeType&&(element=element.parentNode),t.ctrlKey===!0||t.altKey===!0||t.metaKey===!0)return!1;var e=t.keyCode?t.keyCode:t.which;return(!e||"INPUT"!=element.tagName&&"TEXTAREA"!=element.tagName&&"SELECT"!=element.tagName)&&((!e||"true"!=element.contentEditable)&&e)}},wpNoteModel=Backbone.Model.extend({defaults:{summary:"",unread:!0},_reloadBlocked:!1,initialize:function(){},markRead:function(){var t=this.get("unread");if(Boolean(parseInt(t,10))){var e={};e[this.id]=t,wpNotesCommon.markNotesRead(e),wpNotesCommon.bumpStat("notes-read-type",this.get("type"))}},loadBody:function(){wpNotesCommon.createNoteBody(this)},reload:function(){var e=this,n="id,type,unread,noticon,subject,body,date,timestamp,status";return"comment"==e.get("type")&&(n+=",approval_status,has_replied"),!force&&this.isReloadingBlocked()?t.Deferred().reject("reloading blocked"):wpNotesCommon.getNotes({fields:n,trap:!0,ids:[e.get("id")]},function(t){var n=t.notes;"undefined"!=typeof n[0]&&e.set(n[0])},function(){})},resize:function(){this.trigger("resize")},blockReloading:function(t){var e=this;return this._reloadBlocked=!0,clearTimeout(this.reloadBlockerTimeout),this.reloadBlockerTimeout=setTimeout(function(){return e._reloadBlocked=!1},1e3*t)},isReloadingBlocked:function(){return this._reloadBlocked}}),wpNoteList=Backbone.Collection.extend({model:wpNoteModel,lastMarkedSeenTimestamp:!1,newNotes:!1,maxNotes:!1,loading:!1,hasLoaded:!1,allBodiesLoaded:!1,comparator:function(t){return-t.get("timestamp")},addNotes:function(t){t=_.filter(t,function(t){return"object"==typeof t.subject});var e=_.map(t,function(t){return new wpNoteModel(t)});if(this.add(e),this.sort(),this.maxNotes)for(;this.length>this.maxNotes;)this.pop();this.trigger("loadNotes:change")},getMostRecentTimestamp:function(){return!!this.length&&(this.sort(),parseInt(this.at(0).get("timestamp"),10))},loadNotes:function(t){var e=this;e.loading=!0,e.trigger("loadNotes:beginLoading");var n=t.fields,o=parseInt(t.number,10),a=parseInt(t.before,10),s=parseInt(t.since,10),i=parseInt(t.timeout,10)||7e3,r="undefined"==typeof t.type?null:t.type,m="undefined"==typeof t.unread?null:t.unread;return t={timeout:i},n||(n="id,type,unread,noticon,subject,body,date,timestamp,status"),isNaN(o)&&(o=9),isNaN(a)||(t.before=a),isNaN(s)||(t.since=s),null!==m&&(t.unread=m),null!==r&&"unread"!=r&&"latest"!=r&&(t.type=r),t.number=o,t.fields=n,t.trap=!0,wpNotesCommon.getNotes(t).done(function(t){var n,o=t.notes,a=!1;(!e.lastMarkedSeenTimestamp||t.last_seen_time>e.lastMarkedSeenTimestamp)&&(a=!0,e.lastMarkedSeenTimestamp=parseInt(t.last_seen_time,10));for(var s in o){var i=e.get(o[s].id);if(i){if("object"!=typeof o[s].subject){e.remove(o[s].id),a=!0;continue}r&&(n=i.get("queried_types")||{},n[r]=!0,o[s].queried_types=n),i.set(o[s])}else{if("object"!=typeof o[s].subject)continue;r&&(n={},n[r]=!0,o[s].queried_types=n),i=new wpNoteModel(o[s]),e.add(i)}i.has("body")||(e.allBodiesLoaded=!1),a=!0}if(e.maxNotes)for(;e.length>e.maxNotes;)e.pop();a&&(e.sort(),e.trigger("loadNotes:change")),e.loading=!1,e.hasLoaded=!0,e.trigger("loadNotes:endLoading")}).fail(function(t){e.loading=!1,e.trigger("loadNotes:failed")})},loadNoteBodies:function(e){var n=this;if(n.allBodiesLoaded)return(new t.Deferred).resolve();var o=n.getNoteIds(e);if(0==o.length)return(new t.Deferred).reject();for(var a=function(t){var e=t.notes;for(var o in e)if("object"==typeof e[o].subject){var a=n.get(e[o].id);a?a.set(e[o]):(a=new wpNoteModel(e[o]),n.add(a))}},s=function(t){"undefined"!=typeof console&&"function"==typeof console.error&&console.error("body loading error!")},i=[],r=3,m=0;m<r&&"undefined"!=typeof o[m];m++){var c={};c.fields="id,type,unread,noticon,timestamp,subject,body,meta,status",c.trap=!0,c["ids["+m+"]"]=o[m],i.push(wpNotesCommon.getNotes(c).done(a).fail(s))}if(o.length>r){var c={};c.fields="id,type,unread,noticon,timestamp,subject,body,meta,status",c.trap=!0;for(var m=r;m<o.length;m++)c["ids["+m+"]"]=o[m];i.push(wpNotesCommon.getNotes(c).done(a).fail(s))}var p=t.when.apply(null,i);return p.done(function(){"function"!=typeof e&&(n.allBodiesLoaded=!0)}),p},markNotesSeen:function(){var t=this,e=t.getMostRecentTimestamp();e>this.lastMarkedSeenTimestamp&&wpNotesCommon.markNotesSeen(e).done(function(){t.lastMarkedSeenTimestamp=!1})},unreadCount:function(){return this.reduce(function(t,e){return t+(e.get("unread")?1:0)},0)},numberNewNotes:function(){var t=this;return t.lastMarkedSeenTimestamp?t.getNewNotes().length:0},getNewNotes:function(){var t=this;return t.filter(function(e){return e.get("timestamp")>t.lastMarkedSeenTimestamp})},getUnreadNotes:function(){return this.filter(function(t){return Boolean(parseInt(t.get("unread"),10))})},getNotesOfType:function(t){var e=this;switch(t){case"unread":return e.getUnreadNotes();case"latest":return e.filter(function(t){var e=t.get("queried_types");return"undefined"!=typeof e&&"undefined"!=typeof e.latest&&e.latest});default:return e.filter(function(e){var n=e.get("type");if("undefined"==typeof wpNotesCommon.noteTypes[t])return!1;if("string"==typeof wpNotesCommon.noteTypes[t])return t==n;for(var o=wpNotesCommon.noteTypes[t].length,a=0;a<o;a++)if(wpNotesCommon.noteTypes[t][a]==n)return!0;return!1})}},getNoteIds:function(t){return"function"!=typeof t&&(t=function(){return!0}),_.pluck(this.filter(t),"id")}}),wpNotesCommentModView=Backbone.View.extend({mode:"buttons",actionsByName:null,possibleActions:["approve-comment","replyto-comment","like-comment","spam-comment","trash-comment","unapprove-comment","unlike-comment","unspam-comment","untrash-comment"],possibleStatuses:["approved","spam","trash","unapproved"],events:{"click .wpn-replyto-comment-button-open a":"openReply","click .wpn-comment-reply-button-close":"closeReply","click .wpn-comment-reply-button-send":"sendReply","click .wpn-like-comment-button a":"clickLikeComment","click .wpn-unlike-comment-button a":"clickLikeComment","click .wpn-approve-comment-button a":"clickModComment","click .wpn-unapprove-comment-button a":"clickModComment","click .wpn-spam-comment-button a":"clickModComment","click .wpn-unspam-comment-button a":"clickModComment","click .wpn-trash-comment-button a":"clickModComment","click .wpn-untrash-comment-button a":"clickModComment"},templateActions:'\t\t\t{{#reply}}\t\t\t<span class="{{reply.class}}">\t\t\t\t<a href="#" title="{{reply.title}}" data-action-type="{{reply.actionType}}">{{reply.text}}</a>\t\t\t</span>\t\t\t{{/reply}}\t\t\t{{#like}}\t\t\t<span class="{{like.class}}">\t\t\t\t<a href="#" title="{{like.title}}" data-action-type="{{like.actionType}}">{{like.text}}</a>\t\t\t</span>\t\t\t{{/like}}\t\t\t<span class="wpn-more">\t\t\t\t<a href="#">More</a>\t\t\t\t<div class="wpn-more-container">\t\t\t\t{{#spam}}\t\t\t\t<span class="{{spam.class}}">\t\t\t\t\t<a href="#" title="{{spam.title}}" data-action-type="{{spam.actionType}}">{{spam.text}}</a>\t\t\t\t</span>\t\t\t\t{{/spam}}\t\t\t\t{{#trash}}\t\t\t\t<span class="{{trash.class}}">\t\t\t\t\t<a href="#" title="{{trash.title}}" data-action-type="{{trash.actionType}}">{{trash.text}}</a>\t\t\t\t</span>\t\t\t\t{{/trash}}\t\t\t\t</div>\t\t\t</span>\t\t\t{{#approve}}\t\t\t<span class="{{approve.class}}">\t\t\t\t<a href="#" title="{{approve.title}}" data-action-type="{{approve.actionType}}">{{approve.text}}</a>\t\t\t</span>\t\t\t{{/approve}}\t\t\t<span class="wpn-comment-mod-waiting"></span>',templateReply:'\t\t\t<div class="wpn-note-comment-reply">\t\t\t\t<h5>{{reply_header_text}}</h5>\t\t\t\t<textarea class="wpn-note-comment-reply-text" rows="5" cols="45" name="wpn-note-comment-reply-text"></textarea>\t\t\t\t<p class="wpn-comment-submit">\t\t\t\t\t<span class="wpn-comment-submit-waiting" style="display: none;"></span>\t\t\t\t<span class="wpn-comment-submit-error" style="display:none;">Error!</span>\t\t\t\t<a href="#" class="wpn-comment-reply-button-send alignright">{{submit_button_text}}</a>\t\t\t\t<a href="#" class="wpn-comment-reply-button-close alignleft">_</a>\t\t\t\t</p>\t\t\t</div>',initialize:function(){var e=this;return this.setElement(t('<div class="wpn-note-comment-actions" />')),this.listenTo(this.model,"change:status",function(t,n){var o,a;if(o=n.approval_status,a=t.previous("status")||{},!a.approval_status||a.approval_status!==o)return o.match(/^trash|spam$/)?e.setUndoStatus(a.approval_status):void 0}),this.listenTo(this.model,"change",this.render),t(document).on("click",".wpn-more > a",function(e){var n;if(e.preventDefault(),e.stopPropagation(),!e.doneMoreToggle)return e.doneMoreToggle=!0,n=t(e.currentTarget),n.parent().find(".wpn-more-container").toggle(),!1}),t(document).on("click",".wpn-note-body",function(e){var n,o;n=t(e.target),n.parents(".wpn-more").length||(o=n.closest(".wpn-note-body"),o.find(".wpn-more-container").is(":visible")&&o.find(".wpn-more-container").toggle())}),t(".wpn-more-container:not(:has(*))").parents(".wpn-more").hide(),t(document).on("keydown",function(t){var n,o,a;if(!e.$el.is(":hidden")&&"buttons"===e.mode&&(n=wpNotesCommon.getKeycode(t)))return a=e.getValidActions(),o=e.model.get("status")||{},82===n&&_.contains(a,"replyto-comment")&&e.openReply(t),65===n&&(_.contains(a,"approve-comment")?e.modComment("approve-comment"):_.contains(a,"unapprove-comment")&&e.modComment("unapprove-comment")),76===n&&(_.contains(a,"like-comment")?e.likeComment("like-comment"):_.contains(a,"unlike-comment")&&e.likeComment("unlike-comment")),83===n&&(_.contains(a,"spam-comment")?e.modComment("spam-comment"):_.contains(a,"unspam-comment")&&e.modComment("unspam-comment")),84===n&&(_.contains(a,"trash-comment")?e.modComment("trash-comment"):_.contains(a,"untrash-comment")&&e.modComment("untrash-comment")),!1}),this},render:function(){var t;return this.model._changing&&"reply"===this.mode?this:(this.$el.empty(),t=this.model.get("body"),t.actions?(this.updateActionsMap(),"buttons"===this.mode?this.$el.html(this.createActionsHTML()):(this.$el.html(this.createReplyBoxHTML()),this.$("textarea").focus()),this.delegateEvents(),this):this)},setUndoStatus:function(t){return this._undoStatus=t},getUndoStatus:function(){var t;return this._undoStatus?this._undoStatus:(t=this.model.get("status"),null!=t&&"1"===t.undo_status?"approved":"unapproved")},getValidActions:function(){var t,e;switch(e=this.model.get("status")||{},e.approval_status){case"pending":case"unapproved":return["replyto-comment","approve-comment","spam-comment","trash-comment"];case"approved":return t=["replyto-comment","unapprove-comment","spam-comment","trash-comment"],e.i_liked?t.splice(1,0,"unlike-comment"):t.splice(1,0,"like-comment"),t;case"trash":return["untrash-comment"];case"spam":return["unspam-comment"];default:return[]}},getResultantStatus:function(t){switch(t){case"approve-comment":return"approved";case"unapprove-comment":return"unapproved";case"spam-comment":return"spam";case"trash-comment":return"trash";case"unspam-comment":case"untrash-comment":return this.getUndoStatus();default:return}},getStatusParamFromActionType:function(t){if(t)switch(t){case"approve-comment":return"approved";case"unapprove-comment":return"unapproved";default:return t.split("-")[0]}},getComplementaryActionType:function(t){switch(t){case"approve-comment":return"unapprove-comment";case"unapprove-comment":return"approve-comment";case"like-comment":return"unlike-comment";case"unlike-comment":return"like-comment";case"spam-comment":return"unspam-comment";case"trash-comment":return"untrash-comment";case"unspam-comment":return"spam-comment";case"untrash-comment":return"trash-comment";default:return}},getTranslation:function(t){return"undefined"!=typeof notes_i18n&&notes_i18n.translate?notes_i18n.translate(t).fetch():t},getTranslationsForActionType:function(t){var e;return e=this.getTranslation,this._translationsByActionType||(this._translationsByActionType={"approve-comment":{buttonText:e("Approve"),titleText:e("Approve this comment.")},"like-comment":{buttonText:e("Like"),titleText:e("Like this comment.")},"replyto-comment":{buttonText:e("Reply"),titleText:e("Reply to this comment.")},"spam-comment":{buttonText:e("Spam"),titleText:e("Mark this comment as spam.")},"trash-comment":{buttonText:e("Trash"),titleText:e("Move this comment to the trash.")},"unapprove-comment":{buttonText:e("Unapprove"),titleText:e("Unapprove this comment.")},"unlike-comment":{buttonText:e("Liked"),titleText:e("Unlike this comment.")},"unspam-comment":{buttonText:e("Unspam"),titleText:e("Unmark this comment as spam.")},"untrash-comment":{buttonText:e("Untrash"),titleText:e("Restore this comment from the trash.")}}),this._translationsByActionType[t]},updateActionsMap:function(){var e,n,o,a,s,i,r,m,c,p,l,d=this;for(a=this.model.get("body"),o=a.actions||[],this.actionsByName=this.actionsByName||{},s=function(e){if(e.type&&e.params)return d.actionsByName[e.type]=t.extend({},e.params,{actionType:e.type})},i=0,m=o.length;i<m;i++)e=o[i],s(e);for(p=this.possibleActions,l=[],r=0,c=p.length;r<c;r++)n=p[r],l.push(function(e){var n,o,a,s,i,r;if(n=d.actionsByName[e],s=d.getStatusParamFromActionType(e),r=d.getTranslationsForActionType(e),n||(o=d.actionsByName[d.getComplementaryActionType(e)],o&&(d.actionsByName[e]=t.extend({},o,{actionType:e,ajax_arg:s,rest_body:{status:s},text:r.buttonText,title_text:r.titleText}))),"replyto-comment"===e)return a=d.model.get("status"),i="approved"===a.approval_status?d.getTranslation("Reply"):d.getTranslation("Approve and Reply"),t.extend(d.actionsByName["replyto-comment"],{button_text:r.buttonText,submit_button_text:i,text:r.buttonText,title_text:r.titleText})}(n));return l},createActionsHTML:function(){var e,n,o,a,s,i,r,m=this;for(n=this.model.get("status").approval_status,o={},r=this.getValidActions(),a=function(e){var a,s;if(a=m.actionsByName[e])switch(s={class:"wpn-"+e+"-button",actionType:e,text:a.text||a.button_text},e){case"replyto-comment":return o.reply=t.extend({},s,{class:"wpn-replyto-comment-button-open",title:(a.title_text||a.button_title_text)+" [r]"});case"like-comment":case"unlike-comment":return o.like=t.extend({},s,{title:(a.title_text||a.button_title_text)+" [l]"});case"approve-comment":case"unapprove-comment":if(_.contains(["spam","trash"],n))break;return o.approve=t.extend({},s,{title:(a.title_text||a.button_title_text)+" [a]"});case"spam-comment":case"unspam-comment":if("trash"===n)break;return o.spam=t.extend({},s,{title:(a.title_text||a.button_title_text)+" [s]"});case"trash-comment":case"untrash-comment":if("spam"===n)break;return o.trash=t.extend({},s,{title:(a.title_text||a.button_title_text)+" [t]"})}},s=0,i=r.length;s<i;s++)e=r[s],a(e);return Mustache.render(this.templateActions,o)},createReplyBoxHTML:function(){var t,e,n;if(t=this.actionsByName["replyto-comment"])return e=t.site_id||0,n=this.model.id||0,Mustache.render(this.templateReply,{reply_header_text:t.reply_header_text,submit_button_text:t.submit_button_text})},closeReply:function(t){return t&&t.preventDefault(),this.mode="buttons",this.model.currentReplyText=this.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").val(),this.render(),this.model.resize()},openReply:function(e){var n,o,a,s=this;if(e&&e.preventDefault(),this.mode="reply",this.render(),this.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").val(this.model.currentReplyText),t(".selected .wpn-note-body p.submitconfirm").remove(),this.model.resize(),window.mentionDataCache||(window.mentionDataCache=[]),n=this.actionsByName["replyto-comment"],null!=n.site_id)return null!=window.mentionDataCache[n.site_id]?this.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").mentions(window.mentionDataCache[n.site_id]):(window.mentionDataCache[n.site_id]=[],a={site_id:n.site_id,client:"notes-widget"},o=wpNotesCommon.getMentions(a),o.done(function(t){return window.mentionDataCache[n.site_id]=t.suggestions,s.$el.children(".wpn-note-comment-reply").children(".wpn-note-comment-reply-text").mentions(window.mentionDataCache[n.site_id])}))},sendReply:function(e){var n,o,a,s,i,r,m,c=this;return e&&e.preventDefault(),(o=this.actionsByName["replyto-comment"])?(i=this.$el.children(".wpn-note-comment-reply"),this.model.currentReplyText=i.children(".wpn-note-comment-reply-text").val(),a=o.site_id||0,s=o.comment_id||0,r=this.model.currentReplyText||0,a&&s&&r?(n=i.children(".wpn-comment-submit"),n.children(".wpn-comment-submit-error").hide(),n.children(".wpn-comment-reply-button-send").hide(),n.children(".wpn-comment-submit-waiting").gifspin("small").show(),wpNotesCommon.bumpStat("notes-click-action","replyto-comment"),m=function(){return wpNotesCommon.ajax({type:"POST",path:"/sites/"+a+"/comments/"+s+"/replies/new",data:{content:r},success:function(t){return"string"==typeof t?(c.errorReply(t),!1):(c.closeReply(),c.model.currentReplyText="",c.model.reload(!0).done(function(){var t;if(!c.model.get("status").i_replied)return t=0,c.replyCommentInterval=setInterval(function(){return c.model.reload(!0).done(function(){if(c.model.get("status").i_replied||t++>=10)return clearInterval(c.replyCommentInterval)})},3e3)}))},error:function(t){return c.errorReply(t)}}).done(function(){var e,n;return e=t(".selected .wpn-comment-date a").attr("href"),n='<p class="submitconfirm"><strong>',n+=notes_i18n.translate("Reply successful, <a %s>view thread</a>").fetch('target="_blank" href="'+e+'"'),n+="</strong></p>",t(".selected .wpn-note-body").append(n)})},"approved"!==this.model.get("status").approval_status?this.modComment("approve-comment").done(m):m()):t.Deferred().reject("Invalid sendReply params")):t.Deferred().reject("Invalid replyto-comment action")},errorReply:function(e){var n,o,a;if(o=e,"object"==typeof e&&(e.responseText?(a=t.parseJSON(e.responseText),o=a.error+": "+a.message):o=e.statusText?e.statusText:"Unknown Error"),n=this.$el.children(".wpn-note-comment-reply"),n.children(".wpn-comment-submit").children(".wpn-comment-submit-waiting").hide(),o)return n.children(".wpn-comment-submit").children(".wpn-comment-submit-error").text(o).show()},clickModComment:function(e){return e?(e.preventDefault(),this.modComment(t(e.currentTarget).data("action-type"))):t.Deferred.reject("invalid click event")},modComment:function(e){var n,o=this;return this.$(".wpn-comment-mod-waiting").show().gifspin("small"),n=t.Deferred().always(function(){return o.$(".wpn-comment-mod-waiting").empty().hide()}).fail(function(t,e){if("undefined"!=typeof console&&null!==console&&"function"==typeof console.error&&(console.error("Comment moderation error"),t&&console.error(t)),!e||"too_soon"!==e)return o.model.reload()}),this.modPromise&&"function"==typeof this.modPromise.state&&"pending"===this.modPromise.state()?(n.always(function(){return o.$(".wpn-comment-mod-waiting").show().gifspin("small")}),n.reject("Moderation already in progress","too_soon")):(this.modPromise=n.promise(),e&&e.length&&_.contains(this.getValidActions(),e)?(t.Deferred(function(){var a,s;return wpNotesCommon.bumpStat("notes-click-action",e),(a=o.actionsByName[e])?(s=o.getResultantStatus(e),s&&(o.model.set("status",t.extend({},o.model.get("status"),{approval_status:s})),o.$(".wpn-comment-mod-waiting").show().gifspin("small")),wpNotesCommon.ajax({type:"POST",path:a.rest_path,data:a.rest_body}).done(function(e){var a;return a=(null!=e?e.status:void 0)?e.status:"undefined",_.contains(o.possibleStatuses,a)?(o.model.set("status",t.extend({},o.model.get("status"),{approval_status:a})),o.model.blockReloading(15),n.resolve()):n.reject('Invalid status: "'+a+'" received from moderation POST')}).fail(function(t){return n.reject(t)})):n.reject("Undefined action params for type: "+e)}),this.modPromise):n.reject("Invalid actionType"))},clickLikeComment:function(e){var n,o;return e.preventDefault(),n=t(e.currentTarget),o=n.data("action-type"),this.likeComment(o)},likeComment:function(e){var n,o,a,s=this;return n=this.actionsByName[e],"like-comment"===e?(o=!0,a=n.rest_path+"new/"):(o=!1,a=n.rest_path+"mine/delete/"),this.model.set("status",t.extend({},this.model.get("status"),{i_liked:o})),this.$(".wpn-comment-mod-waiting").show().gifspin("small"),wpNotesCommon.ajax({type:"POST",path:a}).done(function(t){return s.$(".wpn-comment-mod-waiting").empty().hide()})}})}(jQuery),function(){!function(t,e){return e.fn.gifspin=function(t){var n,o,a;if(n=e(this),_.isFinite(t)&&t>0)a=Math.min(~~t,128);else switch(t){case"tiny":a=8;break;case"small":a=16;break;case"medium":a=32;break;case"large":a=64;break;default:a=128}return o=e('<img class="gifspinner" src="//s0.wp.com/wp-content/mu-plugins/notes/images/loading.gif" />'),o.css({height:a,width:a}),n.html(o),n}}("undefined"!=typeof exports&&null!==exports?exports:this,window.jQuery)}.call(this);